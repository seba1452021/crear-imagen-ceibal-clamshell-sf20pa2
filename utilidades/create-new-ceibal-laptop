#!/bin/sh

 if [ "$(ceibal-laptop -h 2>/dev/null)" = "" ]; then echo "error" && exit 1; fi
 cd $(dirname $(readlink -f $0)); programas="../programas"
 if [ ! -d "$programas" ]; then mkdir $programas; fi

 file="$programas/new-ceibal-laptop"; echo '#!/bin/sh' > ${file}; busybox dos2unix ${file}; chmod +x ${file}

 if [ "$(echo -e hello)" != "hello" ]; then alias echo="$(which echo)"; fi

 echo -e '\n\tdefault="output"\n\targs="${@}"\n' >> ${file}

 echo -e '\nusage () {\ncat <<EOF' >> ${file}; ceibal-laptop -h >> ${file}; echo -e 'EOF\nexit ${exit_num}\n}\n' >> ${file}

 echo -e '\toutput () { for x in "${id}" "${model}" "${family}" "${build}"; do if [ "$x" != "" ]; then echo "${x}"; fi; done; }' >> ${file}
 echo -e '\tvalues () { output | cut -d " " -f2; }' >> ${file}

 echo -e '\n\tif [ "${args}" = "" ]; then usage; fi\n\tif [ "${args}" = "--values" ]; then usage; fi\n' >> ${file}

 echo '
for n in $args; do i="n"
if [ "$n" = "-i" ]; then i="s"; fi
if [ "$n" = "--id" ]; then i="s"; fi
if [ "$n" = "-m" ]; then i="s"; fi
if [ "$n" = "--model" ]; then i="s"; fi
if [ "$n" = "-f" ]; then i="s"; fi
if [ "$n" = "--family" ]; then i="s"; fi
if [ "$n" = "-b" ]; then i="s"; fi
if [ "$n" = "--build" ]; then i="s"; fi
if [ "$n" = "-?" ]; then i="s" && exit_num="0"; fi
if [ "$n" = "-h" ]; then i="s" && exit_num="0"; fi
if [ "$n" = "--help" ]; then i="s" && exit_num="0"; fi
if [ "$n" = "--values" ]; then i="s" && default="values"; fi
if [ "$i" != "s" ]; then echo "option “$n” not recognized" >&2; exit_num="1"; fi
done
 ' >> ${file}
 
 echo -e '\n\tif [ ! -z "$exit_num" ]; then usage; fi\n\n\n' >> ${file}
 
 echo 'for n in $(echo "$args" | sed -e "s/--values//g" -e "s/--id/-i/g" -e "s/--model/-m/g" -e "s/--family/-f/g" -e "s/--build/-b/g"); do
case $n in
-i) id="ceibal-laptop-id" modelo="" family="" build="" ;;
-m) id="" modelo="ceibal-laptop-model" family="" build="" ;; 
-f) id="" modelo="" family="ceibal-laptop-family" build="" ;;
-b) id="" modelo="" family="" build="ceibal-laptop-build" ;;
esac
"$default"
done
' >> ${file}

 echo -e '\nexit 0' >> ${file}

 sed -i 's/ID/el identificador/g' ${file}
 sed -i 's/ model/ modelo/g' ${file}
 sed -i 's/el build/la construcción/g' ${file}
 sed -i 's/imagen/imagen./g' ${file}
 sed -i 's/-h, --help mostrar/-h || -?, --help muestra/g' ${file}
 
 sed -i 's/del laptop./del laptop/g' ${file}
 sed -i 's/del laptop/del portátil./g' ${file}

 for l in m f b; do sed -i "s/-${l} /-${l}, /g" ${file}; done

 ceibal-laptop --option-n >/dev/null 2>./option-n.txt; option=$(cat ./option-n.txt); rm ./option-n.txt
 
 sed -i "s/unrecognized-option/${option}/g" ${file}
 sed -i 's/--option-n/“${n}”/g' ${file}
 
 sed -i "s/ceibal-laptop-id/$(ceibal-laptop -i)/g" ${file}
 sed -i "s/ceibal-laptop-model/$(ceibal-laptop -m)/g" ${file}
 sed -i "s/ceibal-laptop-family/$(ceibal-laptop -f)/g" ${file}
 sed -i "s/ceibal-laptop-build/$(ceibal-laptop -b)/g" ${file}

 ceibal_laptop_file="$(which ceibal-laptop)"; sed -i "s|${ceibal_laptop_file}|ceibal-laptop-file|g" ${file}
 sed -i 's|ceibal-laptop-file|$(readlink -f $0)|g' ${file}
 
 echo "mv ${file} $ceibal_laptop_file" >> ./control.txt
 
 exit 0
